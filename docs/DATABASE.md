# Base de Datos GoAsync

Esta documentaci√≥n describe la configuraci√≥n y uso de la base de datos PostgreSQL en el proyecto GoAsync.

## üóÑÔ∏è Configuraci√≥n de la Base de Datos

### Especificaciones T√©cnicas

- **Motor**: PostgreSQL 15
- **Puerto**: 5432
- **Base de datos**: `goasync`
- **Usuario**: `postgres`
- **Contrase√±a**: `password`
- **Host**: `localhost` (local) / `postgres` (Docker)

### Extensiones Instaladas

- **uuid-ossp**: Para generaci√≥n de UUIDs
- **pgcrypto**: Para funciones de criptograf√≠a (hash de contrase√±as)

## üöÄ Inicio R√°pido

### Opci√≥n 1: Con Docker (Recomendado)

```bash
# Levantar solo la base de datos
make db-up

# Levantar todos los servicios
make docker-compose-up

# Ver logs de la base de datos
make db-logs
```

### Opci√≥n 2: Instalaci√≥n Local

1. Instalar PostgreSQL 15
2. Crear base de datos:

```sql
CREATE DATABASE goasync;
CREATE USER postgres WITH PASSWORD 'password';
GRANT ALL PRIVILEGES ON DATABASE goasync TO postgres;
```

## üìä Estructura de la Base de Datos

### Tablas Principales

#### `users`

- Almacena informaci√≥n de usuarios del sistema
- Contrase√±as hasheadas con bcrypt
- Soporte para perfiles activos/inactivos

#### `user_profiles`

- Informaci√≥n adicional de usuarios
- Relaci√≥n 1:1 con `users`

#### `categories`

- Categor√≠as para organizar posts
- Sistema de slugs √∫nicos
- Soporte para categor√≠as activas/inactivas

#### `posts`

- Art√≠culos y contenido del sistema
- Sistema de estados (draft, published, archived)
- Relaciones con usuarios y categor√≠as

#### `tags`

- Etiquetas para categorizar posts
- Sistema de slugs √∫nicos

#### `post_tags`

- Tabla de relaci√≥n many-to-many entre posts y tags

#### `comments`

- Sistema de comentarios en posts
- Soporte para comentarios anidados (replies)
- Sistema de aprobaci√≥n de comentarios

#### `user_sessions`

- Gesti√≥n de sesiones de usuario
- Tokens hasheados para seguridad

#### `activity_logs`

- Logs de actividad del sistema
- Almacenamiento en formato JSONB para flexibilidad

### √çndices y Optimizaci√≥n

La base de datos incluye √≠ndices optimizados para:

- B√∫squedas por email y username
- Filtros por estado de posts
- Ordenamiento por fechas
- B√∫squedas por slugs
- Consultas de comentarios

### Triggers y Funciones

#### `update_updated_at_column()`

- Actualiza autom√°ticamente el campo `updated_at`
- Se ejecuta en todas las tablas relevantes

#### `generate_unique_slug()`

- Genera slugs √∫nicos para posts y categor√≠as
- Evita conflictos de nombres duplicados

## üå± Seeder y Datos de Prueba

### Seeder Autom√°tico

El proyecto incluye un seeder completo que puede poblar la base de datos con diferentes vol√∫menes de datos:

#### üî• Seeder Masivo (60,000+ registros)

```bash
# Ejecutar seeder masivo
make seed-massive

# O usar el script directamente
./scripts/seed-db.sh --massive
```

**Genera:**

- **1,000 usuarios** con nombres realistas (Alex, Jordan, Taylor, etc.)
- **15 categor√≠as** (Tecnolog√≠a, Ciencia, Salud, Educaci√≥n, etc.)
- **100+ tags** tecnol√≥gicos y generales
- **5,000 posts** con contenido variado
- **15,000 comentarios** de diferentes usuarios
- **25,000 relaciones** post-tag
- **10,000 logs** de actividad del sistema

#### üìù Seeder B√°sico (30 registros)

```bash
# Ejecutar seeder b√°sico
make seed-small

# O usar el script directamente
./scripts/seed-db.sh --small
```

**Genera:**

- **5 usuarios** b√°sicos (admin, johndoe, janesmith, etc.)
- **8 categor√≠as** principales
- **10 tags** esenciales
- **4 posts** de ejemplo
- **Comentarios** b√°sicos

#### ‚ö° Seeder por Defecto

```bash
# Ejecutar seeder por defecto
make seed
```

### Caracter√≠sticas del Seeder

- **Inserci√≥n en lotes**: Optimizado para insertar miles de registros eficientemente
- **Datos realistas**: Nombres, emails y contenido que simulan un entorno real
- **Relaciones coherentes**: Mantiene integridad referencial entre entidades
- **Logging detallado**: Progreso en tiempo real con emojis y estad√≠sticas
- **Manejo de errores**: Recuperaci√≥n robusta y mensajes informativos

### Comandos Disponibles

```bash
# Comandos principales
make seed              # Seeder b√°sico local
make seed-docker       # Seeder b√°sico en Docker
make seed-massive      # Seeder masivo local
make seed-massive-docker # Seeder masivo en Docker
make seed-small        # Seeder peque√±o local
make seed-small-docker # Seeder peque√±o en Docker

# Con limpieza de base de datos
make seed-clean        # Limpiar DB y ejecutar seeder b√°sico

# Script bash con opciones avanzadas
./scripts/seed-db.sh --help           # Ver todas las opciones
./scripts/seed-db.sh --massive        # Seeder masivo
./scripts/seed-db.sh --small          # Seeder peque√±o
./scripts/seed-db.sh --docker         # Ejecutar en Docker
./scripts/seed-db.sh --clean          # Limpiar DB primero
./scripts/seed-db.sh --verbose        # Modo verbose
```

### Casos de Uso

#### üöÄ Para Pruebas de Rendimiento

```bash
make seed-massive
```

Ideal para probar:

- Consultas complejas con grandes vol√∫menes de datos
- Rendimiento de √≠ndices y optimizaciones
- Escalabilidad de la aplicaci√≥n
- Estrategias de paginaci√≥n

#### üß™ Para Desarrollo R√°pido

```bash
make seed-small
```

Perfecto para:

- Desarrollo y debugging
- Pruebas unitarias
- Demostraciones
- Entornos de staging

#### üîÑ Para Reinicio Limpio

```bash
make seed-clean
```

√ötil cuando:

- Cambias el esquema de la base de datos
- Quieres empezar desde cero
- Hay inconsistencias en los datos
- Cambias entre diferentes modos de seeder

### Datos Generados

#### Usuarios

- Nombres y apellidos realistas de diferentes or√≠genes
- Emails √∫nicos con dominios populares (gmail.com, yahoo.com, etc.)
- Contrase√±as hasheadas (todas usan "password123" por defecto)
- Perfiles activos con timestamps realistas

#### Categor√≠as

- 15 categor√≠as principales que cubren diferentes temas
- Descripciones detalladas y slugs √∫nicos
- Estado activo por defecto

#### Tags

- **Tags tecnol√≥gicos**: Go, Python, JavaScript, Docker, Kubernetes, AWS, etc.
- **Tags generales**: Salud, Fitness, Educaci√≥n, Negocios, Arte, etc.
- Slugs autom√°ticos y descripciones contextuales

#### Posts

- T√≠tulos variados sobre temas tecnol√≥gicos
- Contenido de ejemplo extenso
- Autores asignados aleatoriamente
- Categor√≠as distribuidas uniformemente
- Fechas de publicaci√≥n del √∫ltimo a√±o

#### Comentarios

- 15 plantillas de comentarios realistas
- Distribuci√≥n aleatoria entre posts y usuarios
- 90% de comentarios aprobados por defecto

#### Relaciones Post-Tag

- Asignaci√≥n aleatoria pero coherente
- Evita duplicados con `ON CONFLICT DO NOTHING`
- Distribuci√≥n equilibrada entre entidades

#### Logs de Actividad

- 20 tipos de acciones diferentes
- 8 tipos de recursos
- IPs y user agents simulados
- Timestamps distribuidos

### Rendimiento

El seeder est√° optimizado para:

- **Inserci√≥n en lotes**: Reduce el n√∫mero de consultas a la base de datos
- **Transacciones eficientes**: Mejor rendimiento en grandes vol√∫menes
- **Logging inteligente**: Progreso visible sin saturar la consola
- **Manejo de memoria**: Procesa datos en chunks manejables

### Monitoreo

Durante la ejecuci√≥n del seeder masivo, ver√°s:

- Progreso en tiempo real con emojis
- Contadores de registros insertados
- Logs de cada entidad procesada
- Estad√≠sticas finales completas

### Troubleshooting

#### Error de Memoria

Si el seeder masivo consume mucha memoria:

```bash
# Reducir tama√±o de lotes en el c√≥digo
batchSize := 50  # En lugar de 100 o 500
```

#### Error de Timeout

Si hay timeouts en la base de datos:

```bash
# Aumentar timeouts en docker-compose.yml
command: ["postgres", "-c", "statement_timeout=300000"]
```

#### Limpieza Manual

Si necesitas limpiar manualmente:

```sql
-- Limpiar todas las tablas
TRUNCATE post_tags, comments, posts, tags, user_profiles, users, categories, activity_logs RESTART IDENTITY CASCADE;
```

### Usuarios de Prueba

| Usuario    | Email                   | Contrase√±a  | Rol            |
| ---------- | ----------------------- | ----------- | -------------- |
| admin      | admin@goasync.com       | password123 | Administrador  |
| johndoe    | john.doe@example.com    | password123 | Desarrollador  |
| janesmith  | jane.smith@example.com  | password123 | Arquitecta     |
| bobwilson  | bob.wilson@example.com  | password123 | DevOps         |
| alicebrown | alice.brown@example.com | password123 | Data Scientist |

## üõ†Ô∏è Comandos √ötiles

### Makefile

```bash
# Gesti√≥n de base de datos
make db-up          # Levantar servicios de BD
make db-down        # Detener servicios
make db-reset       # Reiniciar BD (eliminar vol√∫menes)
make db-logs        # Ver logs de PostgreSQL
make db-connect     # Conectar a PostgreSQL

# Seeder
make seed           # Ejecutar seeder local
make seed-docker    # Ejecutar seeder en Docker
make seed-clean     # Limpiar y ejecutar seeder

# Desarrollo completo
make dev-full       # Levantar BD + seeder + aplicaci√≥n
make dev-docker     # Todo en Docker
```

### Scripts

```bash
# Seeder con opciones
./scripts/seed-db.sh --help
./scripts/seed-db.sh --clean --verbose
./scripts/seed-db.sh --docker
```

## üîç Consultas √ötiles

### Estad√≠sticas de la Base de Datos

```sql
SELECT * FROM get_database_stats();
```

### Posts Activos con Informaci√≥n

```sql
SELECT * FROM active_posts;
```

### Estad√≠sticas de Usuarios

```sql
SELECT * FROM user_stats;
```

### Posts por Categor√≠a

```sql
SELECT
    c.name as category,
    COUNT(p.id) as post_count
FROM categories c
LEFT JOIN posts p ON c.id = p.category_id
WHERE c.is_active = true
GROUP BY c.id, c.name
ORDER BY post_count DESC;
```

### Usuarios M√°s Activos

```sql
SELECT
    u.username,
    COUNT(p.id) as posts_written,
    COUNT(c.id) as comments_made
FROM users u
LEFT JOIN posts p ON u.id = p.author_id
LEFT JOIN comments c ON u.id = c.author_id
GROUP BY u.id, u.username
ORDER BY (posts_written + comments_made) DESC;
```

## üê≥ Docker

### Servicios Incluidos

- **PostgreSQL**: Base de datos principal
- **Redis**: Cache y sesiones (para futuras implementaciones)
- **pgAdmin**: Interfaz web para administrar PostgreSQL

### Acceso a pgAdmin

- **URL**: http://localhost:5050
- **Email**: admin@goasync.com
- **Contrase√±a**: admin123

### Configuraci√≥n de Red

- **Red**: `goasync_goasync-network`
- **Subnet**: `172.20.0.0/16`
- **Puertos expuestos**: 5432, 6379, 5050

## üîß Variables de Entorno

```bash
# Base de datos
DB_HOST=localhost          # o 'postgres' para Docker
DB_PORT=5432
DB_NAME=goasync
DB_USER=postgres
DB_PASSWORD=password
DB_SSLMODE=disable

# Redis
REDIS_HOST=localhost       # o 'redis' para Docker
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
```

## üìà Monitoreo y Mantenimiento

### Health Checks

Los contenedores incluyen health checks autom√°ticos:

- **PostgreSQL**: `pg_isready` cada 10 segundos
- **Redis**: `redis-cli ping` cada 10 segundos

### Logs

```bash
# Ver logs de PostgreSQL
make db-logs

# Ver logs de Redis
docker-compose logs -f redis

# Ver logs de pgAdmin
docker-compose logs -f pgadmin
```

### Backup y Restore

```bash
# Backup
docker-compose exec postgres pg_dump -U postgres goasync > backup.sql

# Restore
docker-compose exec -T postgres psql -U postgres goasync < backup.sql
```

## üö® Soluci√≥n de Problemas

### Problemas Comunes

#### 1. Puerto 5432 ya en uso

```bash
# Ver qu√© est√° usando el puerto
lsof -i :5432

# Detener servicio local de PostgreSQL
sudo service postgresql stop
```

#### 2. Error de conexi√≥n en Docker

```bash
# Verificar que los contenedores est√©n ejecut√°ndose
docker-compose ps

# Reiniciar servicios
docker-compose restart postgres
```

#### 3. Error de permisos en vol√∫menes

```bash
# Limpiar vol√∫menes y reiniciar
make db-reset
```

### Verificaci√≥n de Estado

```bash
# Verificar estado de contenedores
docker-compose ps

# Verificar logs
docker-compose logs postgres

# Verificar conectividad
make db-connect
```

## üîÆ Futuras Mejoras

- [ ] Migraciones autom√°ticas con herramientas como `golang-migrate`
- [ ] Replicaci√≥n maestro-esclavo para alta disponibilidad
- [ ] Backup autom√°tico programado
- [ ] Monitoreo con Prometheus y Grafana
- [ ] Particionamiento de tablas grandes
- [ ] Compresi√≥n de datos hist√≥ricos
- [ ] Auditor√≠a completa de cambios

## üìö Recursos Adicionales

- [Documentaci√≥n oficial de PostgreSQL](https://www.postgresql.org/docs/)
- [Docker Hub PostgreSQL](https://hub.docker.com/_/postgres)
- [pgAdmin Documentation](https://www.pgadmin.org/docs/)
- [PostgreSQL Performance Tuning](https://www.postgresql.org/docs/current/performance.html)
